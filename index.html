<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket Finance</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pocket Finance">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="/manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        success: '#10b981',
                        danger: '#ef4444',
                        bg: '#f8fafc',
                        card: '#ffffff'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Safe Area adjustments */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Hide Scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Smooth inputs */
        input,
        select {
            font-size: 16px !important;
            /* Prevents iOS zoom on focus */
        }

        /* Modal Animation */
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }
    </style>
</head>

<body class="bg-bg text-slate-800 h-screen flex flex-col overflow-hidden">

    <header class="px-6 pt-6 pb-4 bg-white shadow-sm z-10 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Pocket Finance</h1>
            <p class="text-xs text-slate-500" id="current-date">Loading...</p>
        </div>
        <div class="flex gap-3 items-center">
            <button id="login-btn" onclick="googleLogin()"
                class="hidden bg-white border border-slate-200 text-slate-600 px-3 h-10 rounded-full flex items-center gap-2 text-xs font-bold hover:bg-slate-50 transition">
                <i class="fa-brands fa-google text-red-500"></i> Sync
            </button>

            <button onclick="toggleAnalytics()"
                class="bg-slate-100 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition">
                <i class="fa-solid fa-chart-pie"></i>
            </button>

            <div id="user-profile" class="hidden relative flex items-center gap-2">
                <img id="user-avatar" src="" onclick="toggleProfileMenu()"
                    class="w-10 h-10 rounded-full border-2 border-white shadow-sm cursor-pointer hover:scale-105 transition"
                    alt="User">

                <!-- Dropdown Menu -->
                <div id="profile-menu"
                    class="hidden absolute top-12 right-0 bg-white shadow-xl rounded-xl p-1 z-50 min-w-[140px] border border-slate-100 animate-in fade-in slide-in-from-top-2 duration-200">
                    <button onclick="googleLogout()"
                        class="w-full text-left text-sm text-red-500 font-medium hover:bg-red-50 px-3 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Install App Banner -->
    <div id="install-banner"
        class="hidden bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 shadow-lg z-20">
        <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 flex-1">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-download text-blue-600 text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm">Install Pocket Finance</p>
                    <p class="text-xs text-blue-100">Add to home screen for quick access</p>
                </div>
            </div>
            <div class="flex gap-2 flex-shrink-0">
                <button onclick="installApp()"
                    class="bg-white text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-50 active:scale-95 transition">
                    Install
                </button>
                <button onclick="dismissInstallBanner()" class="text-white hover:text-blue-100 p-2">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
        </div>
    </div>


    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24" id="main-container">

        <div
            class="bg-gradient-to-br from-primary to-blue-600 rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
            <p class="text-blue-100 text-sm font-medium mb-1">Total Balance</p>
            <h2 class="text-3xl font-bold tracking-tight mb-4" id="total-balance">₹0.00</h2>

            <div class="flex gap-4">
                <div class="flex-1 bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-5 h-5 rounded-full bg-green-400/30 flex items-center justify-center">
                            <i class="fa-solid fa-arrow-down text-green-300 text-[10px]"></i>
                        </div>
                        <span class="text-xs text-blue-50">Income</span>
                    </div>
                    <p class="font-semibold text-lg" id="total-income">₹0.00</p>
                </div>
                <div class="flex-1 bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-5 h-5 rounded-full bg-red-400/30 flex items-center justify-center">
                            <i class="fa-solid fa-arrow-up text-red-300 text-[10px]"></i>
                        </div>
                        <span class="text-xs text-blue-50">Expense</span>
                    </div>
                    <p class="font-semibold text-lg" id="total-expense">₹0.00</p>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 px-1">
            <h3 class="font-bold text-lg text-slate-800">Transactions</h3>
            <div class="flex gap-2">
                <select id="filter-date" onchange="renderUI()"
                    class="bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-2 py-1 focus:outline-none">
                    <option value="all">All Time</option>
                    <option value="thisMonth">This Month</option>
                    <option value="lastMonth">Last Month</option>
                    <option value="thisYear">This Year</option>
                </select>
                <select id="filter-type" onchange="renderUI()"
                    class="bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-2 py-1 focus:outline-none">
                    <option value="all">All Types</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>
        </div>

        <div id="empty-state" class="hidden flex-col items-center justify-center py-12 text-slate-400">
            <i class="fa-solid fa-receipt text-4xl mb-3 opacity-50"></i>
            <p class="text-sm">No transactions yet.</p>
        </div>

        <div id="transaction-list" class="space-y-3">
        </div>
    </main>

    <div class="fixed bottom-6 right-6 z-20">
        <button onclick="openAddModal()"
            class="w-14 h-14 bg-primary text-white rounded-full shadow-xl shadow-blue-500/40 flex items-center justify-center text-2xl hover:bg-blue-700 active:scale-90 transition">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div id="add-modal" class="modal fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4 sm:p-0">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleModal('add-modal')"></div>

        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative shadow-2xl z-10 mb-4 sm:mb-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="modal-title">New Transaction</h3>
                <button onclick="toggleModal('add-modal')" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <form id="transaction-form" onsubmit="addTransaction(event)">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">₹</span>
                        <input type="number" id="amount" step="0.01" inputmode="decimal" required
                            class="w-full pl-8 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white text-lg font-semibold"
                            placeholder="0.00">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Date</label>
                    <input type="date" id="transaction-date" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white text-lg font-semibold">
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Description <span
                            class="text-slate-300 font-normal lowercase">(optional)</span></label>
                    <input type="text" id="description"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white"
                        placeholder="e.g. Groceries">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Type</label>
                        <select id="type" onchange="updateCategories()"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white appearance-none">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Category</label>
                        <select id="category"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white appearance-none">
                        </select>
                    </div>
                </div>

                <button type="submit" id="submit-btn"
                    class="w-full bg-primary text-white font-bold py-4 rounded-xl hover:bg-blue-700 active:scale-95 transition shadow-lg shadow-blue-500/30">
                    Add Transaction
                </button>
            </form>
        </div>
    </div>

    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal fixed inset-0 z-50 flex flex-col bg-bg overflow-hidden">
        <div class="bg-white px-6 py-4 shadow-sm flex justify-between items-center z-10">
            <h2 class="text-xl font-bold text-slate-900">Analytics</h2>
            <button onclick="toggleAnalytics()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
            <!-- Controls -->
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-6">
                <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="setFilter('thisMonth')"
                        class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-primary text-white whitespace-nowrap"
                        id="btn-thisMonth">This Month</button>
                    <button onclick="setFilter('lastMonth')"
                        class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-500 whitespace-nowrap"
                        id="btn-lastMonth">Last Month</button>
                    <button onclick="setFilter('all')"
                        class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-500 whitespace-nowrap"
                        id="btn-all">All Time</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Start</label>
                        <input type="date" id="date-start" onchange="customDateFilter()"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-xs font-semibold">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">End</label>
                        <input type="date" id="date-end" onchange="customDateFilter()"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-xs font-semibold">
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-3 gap-2 mb-6">
                <div class="bg-green-50 p-3 rounded-xl border border-green-100">
                    <p class="text-[10px] text-green-600 font-bold uppercase mb-1">Income</p>
                    <p class="text-sm font-bold text-green-700" id="analytics-income">₹0</p>
                </div>
                <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                    <p class="text-[10px] text-red-600 font-bold uppercase mb-1">Expense</p>
                    <p class="text-sm font-bold text-red-700" id="analytics-expense">₹0</p>
                </div>
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold uppercase mb-1">Balance</p>
                    <p class="text-sm font-bold text-blue-700" id="analytics-balance">₹0</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-6">
                <h3 class="font-bold text-slate-800 mb-4 text-sm">Expense Breakdown</h3>
                <div class="h-64 relative">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm mb-24">
                <h3 class="font-bold text-slate-800 mb-4 text-sm">Income vs Expense</h3>
                <div class="h-48 relative">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="absolute bottom-6 left-0 right-0 px-6 flex justify-center">
            <button onclick="exportAnalyticsReport()"
                class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 font-bold text-sm hover:bg-slate-900 active:scale-95 transition">
                <i class="fa-solid fa-file-export"></i> Export Report
            </button>
        </div>
    </div>

    <div id="pdf-container" class="hidden bg-white p-8">
        <h1 class="text-2xl font-bold mb-2 text-center">Financial Report</h1>
        <p class="text-center text-gray-500 text-sm mb-6" id="pdf-date"></p>

        <div class="grid grid-cols-3 gap-4 mb-6 border-b pb-6">
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Income</p>
                <p class="text-green-600 font-bold text-lg" id="pdf-income"></p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Expenses</p>
                <p class="text-red-600 font-bold text-lg" id="pdf-expense"></p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Net Balance</p>
                <p class="text-blue-600 font-bold text-lg" id="pdf-balance"></p>
            </div>
        </div>

        <table class="w-full text-left text-sm">
            <thead>
                <tr class="border-b-2 border-gray-200">
                    <th class="py-2">Date</th>
                    <th class="py-2">Description</th>
                    <th class="py-2">Category</th>
                    <th class="py-2 text-right">Amount</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
            </tbody>
        </table>
    </div>

    <script>
        // ==========================================
        // FIREBASE CONFIGURATION (REQUIRED FOR SYNC)
        // ==========================================
        // 1. Go to console.firebase.google.com
        // 2. Create a new project
        // 3. Enable "Authentication" > "Google"
        // 4. Enable "Cloud Firestore" > "Create Database"
        // 5. Go to Project Settings > General > "Your apps" > SDK Setup and copy the config object below:

        // const firebaseConfig = {
        //     apiKey: "YOUR_API_KEY_HERE",
        //     authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        //     projectId: "YOUR_PROJECT_ID",
        //     storageBucket: "YOUR_PROJECT_ID.appspot.com",
        //     messagingSenderId: "YOUR_SENDER_ID",
        //     appId: "YOUR_APP_ID"
        // };

        const firebaseConfig = {
            apiKey: "AIzaSyDaGRXYekB8nSGD6RfMJMuJD_h5cogmSbE",
            authDomain: "my-finance-tracker-yuva.firebaseapp.com",
            projectId: "my-finance-tracker-yuva",
            storageBucket: "my-finance-tracker-yuva.firebasestorage.app",
            messagingSenderId: "230460049894",
            appId: "1:230460049894:web:0a26d8c5503805a2b72e27",
            measurementId: "G-HM2JXMVZ9T"
        };
        // Initialize Firebase safely
        let auth, db, currentUser = null;
        let isFirebaseReady = false;

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;

            // Auth Listener
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateAuthUI(user);
                if (user) {
                    syncLocalToCloud();
                } else {
                    // If logged out, revert to local storage
                    loadFromLocal();
                }
            });
        } catch (e) {
            console.error("Firebase Error:", e);
        }

        // --- Data & State ---
        let transactions = [];
        let editingTransactionId = null;

        const categories = {
            expense: ['Food', 'Transport', 'Shopping', 'Bills', 'Health', 'Entertainment', 'Other'],
            income: ['Salary', 'Freelance', 'Gift', 'Investment', 'Other']
        };

        const iconMap = {
            'Food': 'fa-utensils',
            'Transport': 'fa-car',
            'Shopping': 'fa-bag-shopping',
            'Bills': 'fa-file-invoice-dollar',
            'Health': 'fa-heart-pulse',
            'Entertainment': 'fa-film',
            'Salary': 'fa-money-bill-wave',
            'Freelance': 'fa-laptop-code',
            'Gift': 'fa-gift',
            'Investment': 'fa-chart-line',
            'Other': 'fa-circle-question'
        };

        // --- PWA Install Logic ---
        let deferredPrompt;

        // Capture the install prompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing
            e.preventDefault();
            // Save the event for later use
            deferredPrompt = e;

            // Check if user has dismissed the banner before
            const dismissed = localStorage.getItem('install-banner-dismissed');
            if (!dismissed) {
                // Show the install banner
                document.getElementById('install-banner').classList.remove('hidden');
            }
        });

        async function installApp() {
            if (!deferredPrompt) {
                // For iOS: Show instructions since PWA install is not available via API
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    alert('To install:\n1. Tap the Share button\n2. Scroll and tap "Add to Home Screen"\n3. Tap "Add"');
                }
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user's response
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }

            // Clear the deferredPrompt
            deferredPrompt = null;

            // Hide the banner
            document.getElementById('install-banner').classList.add('hidden');
        }

        function dismissInstallBanner() {
            document.getElementById('install-banner').classList.add('hidden');
            // Remember that user dismissed the banner (for 30 days)
            localStorage.setItem('install-banner-dismissed', Date.now());
            setTimeout(() => {
                localStorage.removeItem('install-banner-dismissed');
            }, 30 * 24 * 60 * 60 * 1000); // 30 days
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            document.getElementById('install-banner').classList.add('hidden');
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', month: 'long', day: 'numeric' });
            updateCategories();

            // Initial load from local storage (will be overwritten if Firebase loads user)
            if (!currentUser) loadFromLocal();
        });

        // --- Auth Functions ---
        function googleLogin() {
            if (!isFirebaseReady) return alert("Please configure Firebase keys in the code first.");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => alert(error.message));
        }

        function googleLogout() {
            auth.signOut();
            transactions = []; // Clear current view
            loadFromLocal(); // Revert to local
        }

        function updateAuthUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userProfile = document.getElementById('user-profile');
            const avatar = document.getElementById('user-avatar');

            if (user) {
                loginBtn.classList.add('hidden');
                loginBtn.classList.remove('flex');
                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                avatar.src = user.photoURL;
            } else {
                loginBtn.classList.remove('hidden');
                loginBtn.classList.add('flex');
                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
            }
        }

        // --- Storage Logic ---
        function loadFromLocal() {
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            renderUI();
        }

        function loadFromCloud() {
            if (!currentUser) return;
            // Listen for realtime updates
            db.collection('users').doc(currentUser.uid).collection('transactions')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
        }

        async function syncLocalToCloud() {
            if (!currentUser || !isFirebaseReady) return;

            // Get local storage data
            const localTransactions = JSON.parse(localStorage.getItem('transactions')) || [];

            if (localTransactions.length === 0) {
                // No local data, just load from cloud
                loadFromCloud();
                return;
            }

            try {
                // Get existing cloud data
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('transactions').get();
                const cloudTransactionIds = new Set(snapshot.docs.map(doc => doc.id));

                // Upload local transactions that don't exist in cloud (dedupe by ID)
                const batch = db.batch();
                let syncCount = 0;

                localTransactions.forEach(tx => {
                    if (!cloudTransactionIds.has(String(tx.id))) {
                        const { id, ...data } = tx;
                        const docRef = db.collection('users').doc(currentUser.uid).collection('transactions').doc(String(id));
                        batch.set(docRef, data);
                        syncCount++;
                    }
                });

                // Commit the batch upload
                if (syncCount > 0) {
                    await batch.commit();
                    console.log(`Synced ${syncCount} transactions from local storage to cloud`);
                }

                // Clear local storage after successful sync
                localStorage.removeItem('transactions');

                // Now load from cloud (which will trigger the snapshot listener)
                loadFromCloud();
            } catch (error) {
                console.error('Error syncing local to cloud:', error);
                // Fallback to just loading from cloud
                loadFromCloud();
            }
        }

        function saveData(newTx = null, deleteId = null) {
            // If Logged In -> Use Cloud
            if (currentUser && isFirebaseReady) {
                if (newTx) {
                    // Add new
                    // We remove ID from object because Firestore creates its own or we use the specific one
                    const { id, ...data } = newTx;
                    db.collection('users').doc(currentUser.uid).collection('transactions').doc(String(newTx.id)).set(data);
                }
                if (deleteId) {
                    // Delete
                    db.collection('users').doc(currentUser.uid).collection('transactions').doc(String(deleteId)).delete();
                }
            }
            // If Logged Out -> Use LocalStorage
            else {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                renderUI(); // Only need to manually re-render for local storage
            }
        }

        // --- Core Functions ---

        function updateCategories() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '';

            categories[type].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        function formatCurrency(amount) {
            // Updated to Indian Rupee
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
        }

        function addTransaction(e) {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value.trim() || 'Untitled';
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const dateInput = document.getElementById('transaction-date').value;

            if (!amount || !dateInput) return;

            // Create ISO string from date input (preserve time if editing, else set to noon to avoid timezone issues)
            const dateObj = new Date(dateInput);
            const isoDate = dateObj.toISOString();

            if (editingTransactionId) {
                // UPDATE EXISTING
                const updatedTx = {
                    id: editingTransactionId,
                    date: isoDate,
                    amount,
                    description,
                    type,
                    category
                };

                if (!currentUser) {
                    const index = transactions.findIndex(t => String(t.id) === String(editingTransactionId));
                    if (index !== -1) transactions[index] = updatedTx;
                }

                saveData(updatedTx, null);
            } else {
                // CREATE NEW
                const newTransaction = {
                    id: Date.now(),
                    date: isoDate,
                    amount,
                    description,
                    type,
                    category
                };

                if (!currentUser) {
                    transactions.unshift(newTransaction);
                }

                saveData(newTransaction, null);
            }

            if (!currentUser) renderUI();

            toggleModal('add-modal');
        }

        function editTransaction(id) {
            const tx = transactions.find(t => String(t.id) === String(id));
            if (!tx) return;

            editingTransactionId = id;

            document.getElementById('amount').value = tx.amount;
            document.getElementById('description').value = tx.description;
            document.getElementById('type').value = tx.type;
            updateCategories(); // Refresh categories based on type
            document.getElementById('category').value = tx.category;

            // Format date for input
            const d = new Date(tx.date);
            const offset = d.getTimezoneOffset() * 60000;
            const dateStr = new Date(d.getTime() - offset).toISOString().split('T')[0];
            document.getElementById('transaction-date').value = dateStr;

            document.getElementById('modal-title').textContent = "Edit Transaction";
            document.getElementById('submit-btn').textContent = "Update Transaction";

            toggleModal('add-modal');
        }

        function openAddModal() {
            editingTransactionId = null;
            document.getElementById('transaction-form').reset();

            // Set default date to today
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const today = new Date(now.getTime() - offset).toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;

            document.getElementById('modal-title').textContent = "New Transaction";
            document.getElementById('submit-btn').textContent = "Add Transaction";
            updateCategories();
            toggleModal('add-modal');
        }

        function deleteTransaction(id) {
            if (confirm("Delete this transaction?")) {
                if (!currentUser) {
                    transactions = transactions.filter(t => String(t.id) !== String(id));
                }
                saveData(null, id);
            }
        }

        function clearAllData() {
            const msg = currentUser ? "Clear all CLOUD data?" : "Clear all LOCAL data?";
            if (confirm(`${msg} This cannot be undone.`)) {
                if (currentUser) {
                    // Batch delete for firestore is complex for simple JS, looping for simplicity here
                    transactions.forEach(t => {
                        db.collection('users').doc(currentUser.uid).collection('transactions').doc(String(t.id)).delete();
                    });
                } else {
                    transactions = [];
                    saveData();
                }
            }
        }

        // --- UI Rendering ---

        function renderUI() {
            const list = document.getElementById('transaction-list');
            const emptyState = document.getElementById('empty-state');
            const filterType = document.getElementById('filter-type').value;
            const filterDate = document.getElementById('filter-date').value;

            // 1. Filter by Date Range
            let dateFiltered = transactions;
            const now = new Date();

            if (filterDate === 'thisMonth') {
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                dateFiltered = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= start && d <= end;
                });
            } else if (filterDate === 'lastMonth') {
                const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                dateFiltered = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= start && d <= end;
                });
            } else if (filterDate === 'thisYear') {
                const start = new Date(now.getFullYear(), 0, 1);
                const end = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                dateFiltered = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= start && d <= end;
                });
            }

            // 2. Calculate Totals (Based on Date Filtered Data)
            const income = dateFiltered.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = dateFiltered.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            // Update Cards
            document.getElementById('total-balance').textContent = formatCurrency(balance);
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expense').textContent = formatCurrency(expense);

            // 3. Filter by Type
            let finalFiltered = dateFiltered;
            if (filterType !== 'all') {
                finalFiltered = dateFiltered.filter(t => t.type === filterType);
            }

            // Render List
            list.innerHTML = '';

            if (finalFiltered.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');

                // Group by Month
                const groups = {};
                finalFiltered.forEach(t => {
                    const date = new Date(t.date);
                    const key = date.toLocaleString('en-IN', { month: 'long', year: 'numeric' });
                    if (!groups[key]) groups[key] = { items: [], total: 0 };
                    groups[key].items.push(t);
                    groups[key].total += (t.type === 'income' ? t.amount : -t.amount);
                });

                Object.keys(groups).forEach(key => {
                    const group = groups[key];
                    const groupId = key.replace(/ /g, '-');

                    const groupHeader = document.createElement('div');
                    groupHeader.className = "flex justify-between items-center px-2 py-2 cursor-pointer select-none";
                    groupHeader.onclick = () => toggleGroup(groupId);
                    groupHeader.innerHTML = `
                        <div class="flex items-center gap-2">
                            <i id="icon-${groupId}" class="fa-solid fa-chevron-down text-slate-400 text-xs transition-transform"></i>
                            <h4 class="text-xs font-bold text-slate-500 uppercase">${key}</h4>
                        </div>
                        <span class="text-xs font-bold ${group.total >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(group.total)}</span>
                    `;
                    list.appendChild(groupHeader);

                    const groupContent = document.createElement('div');
                    groupContent.id = `group-${groupId}`;
                    // Grid layout: 2 col mobile, 2 col tablet (sm), 3 col md, 4 col large screens
                    groupContent.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4 transition-all overflow-hidden";

                    group.items.forEach(t => {
                        const isIncome = t.type === 'income';
                        const colorClass = isIncome ? 'text-green-600' : 'text-red-400';
                        const iconBg = isIncome ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-500';
                        const sign = isIncome ? '+' : '-';
                        const date = new Date(t.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });

                        const item = document.createElement('div');
                        // Card styling
                        item.className = 'transaction-card bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col gap-4 hover:shadow-md transition-all duration-200 relative group cursor-pointer';
                        item.onclick = (e) => {
                            if (e.target.closest('button')) return;
                            // Toggle buttons visibility
                            const buttons = item.querySelector('.action-buttons');
                            const allButtons = document.querySelectorAll('.action-buttons');
                            const allCards = document.querySelectorAll('.transaction-card');

                            // Remove highlight from all cards and hide all buttons
                            allCards.forEach(card => {
                                card.classList.remove('border-primary', 'bg-blue-50', 'shadow-lg');
                                card.classList.add('border-slate-100', 'bg-white');
                            });
                            allButtons.forEach(btn => {
                                btn.classList.add('hidden');
                            });

                            // Toggle current card highlight and buttons
                            const isCurrentlyHidden = buttons.classList.contains('hidden');
                            if (isCurrentlyHidden) {
                                item.classList.remove('border-slate-100', 'bg-white');
                                item.classList.add('border-primary', 'bg-blue-50', 'shadow-lg');
                                buttons.classList.remove('hidden');
                            }
                        };

                        item.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="w-12 h-12 rounded-xl ${iconBg} flex items-center justify-center text-xl shadow-sm">
                                    <i class="fa-solid ${iconMap[t.category] || 'fa-circle'}"></i>
                                </div>
                                <div class="action-buttons hidden flex gap-1 transition-opacity">
                                    <button onclick="editTransaction('${t.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-blue-50 hover:text-blue-600 flex items-center justify-center transition-colors" title="Edit">
                                        <i class="fa-solid fa-pen text-xs"></i>
                                    </button>
                                    <button onclick="deleteTransaction('${t.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-600 flex items-center justify-center transition-colors" title="Delete">
                                        <i class="fa-solid fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg leading-tight mb-1 line-clamp-1" title="${t.description}">${t.description}</h4>
                                <div class="flex items-center gap-2 text-xs text-slate-500 font-medium">
                                    <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600">${t.category}</span>
                                    <span>•</span>
                                    <span>${date}</span>
                                </div>
                            </div>

                            <div class="mt-auto pt-3 border-t border-slate-50 flex justify-end items-center">
                                <span class="font-bold text-xl ${colorClass}">${sign}₹${formatCurrency(t.amount).replace('₹', '')}</span>
                            </div>
                        `;
                        groupContent.appendChild(item);
                    });
                    list.appendChild(groupContent);
                });
            }
        }

        function toggleGroup(id) {
            const content = document.getElementById(`group-${id}`);
            const icon = document.getElementById(`icon-${id}`);

            if (content.style.maxHeight === '0px') {
                content.style.maxHeight = content.scrollHeight + "px";
                content.style.opacity = "1";
                content.style.marginBottom = "1rem";
                icon.style.transform = "rotate(0deg)";
            } else {
                // Initialize if inline style not set
                if (!content.style.maxHeight) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    // Force reflow
                    content.offsetHeight;
                    content.style.maxHeight = "0px";
                } else {
                    content.style.maxHeight = "0px";
                }
                content.style.opacity = "0";
                content.style.marginBottom = "0";
                icon.style.transform = "rotate(-90deg)";
            }
        }

        // --- Helper Functions ---

        function toggleModal(id) {
            const modal = document.getElementById(id);
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
            } else {
                modal.classList.add('active');
                setTimeout(() => document.getElementById('amount').focus(), 100);
            }
        }

        // --- PDF Export Logic ---

        function exportToPDF() {
            const btn = document.querySelector('header button:last-child');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            const pdfBody = document.getElementById('pdf-table-body');
            pdfBody.innerHTML = '';

            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('pdf-date').textContent = `Generated on ${new Date().toLocaleString()}`;
            document.getElementById('pdf-income').textContent = formatCurrency(income);
            document.getElementById('pdf-expense').textContent = formatCurrency(expense);
            document.getElementById('pdf-balance').textContent = formatCurrency(income - expense);

            transactions.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100";
                const isInc = t.type === 'income';
                tr.innerHTML = `
                    <td class="py-2 text-gray-500">${new Date(t.date).toLocaleDateString()}</td>
                    <td class="py-2 font-medium">${t.description}</td>
                    <td class="py-2 text-gray-500">${t.category}</td>
                    <td class="py-2 text-right font-bold ${isInc ? 'text-green-600' : 'text-red-600'}">
                        ${isInc ? '+' : '-'}${formatCurrency(t.amount)}
                    </td>
                `;
                pdfBody.appendChild(tr);
            });

            const element = document.getElementById('pdf-container');
            element.classList.remove('hidden');

            const opt = {
                margin: 0.5,
                filename: `Finance_Report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.add('hidden');
                btn.innerHTML = originalIcon;
            });
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('hidden');
        }

        // Close menu when clicking outside
        window.addEventListener('click', (e) => {
            const menu = document.getElementById('profile-menu');
            const avatar = document.getElementById('user-avatar');
            if (menu && !menu.classList.contains('hidden') && e.target !== avatar && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // --- Analytics Logic ---

        let expenseChartInstance = null;
        let trendChartInstance = null;
        let currentFilteredTransactions = [];

        function toggleAnalytics() {
            const modal = document.getElementById('analytics-modal');
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
            } else {
                modal.classList.add('active');
                setFilter('thisMonth');
            }
        }

        function setFilter(type) {
            const now = new Date();
            let start, end;

            // Update Buttons
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-primary', 'text-white');
                b.classList.add('bg-slate-100', 'text-slate-500');
            });
            document.getElementById(`btn-${type}`).classList.remove('bg-slate-100', 'text-slate-500');
            document.getElementById(`btn-${type}`).classList.add('bg-primary', 'text-white');

            if (type === 'thisMonth') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (type === 'lastMonth') {
                start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                end = new Date(now.getFullYear(), now.getMonth(), 0);
            } else {
                start = new Date(0); // Beginning of time
                end = new Date();
            }

            // Set inputs (adjust for timezone offset to show correct date string)
            const formatDate = (d) => {
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().split('T')[0];
            };

            if (type !== 'all') {
                document.getElementById('date-start').value = formatDate(start);
                document.getElementById('date-end').value = formatDate(end);
            } else {
                document.getElementById('date-start').value = '';
                document.getElementById('date-end').value = '';
            }

            renderAnalytics(start, end);
        }

        function customDateFilter() {
            const startStr = document.getElementById('date-start').value;
            const endStr = document.getElementById('date-end').value;

            if (startStr && endStr) {
                // Deselect presets
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-primary', 'text-white');
                    b.classList.add('bg-slate-100', 'text-slate-500');
                });
                renderAnalytics(new Date(startStr), new Date(endStr));
            }
        }

        function renderAnalytics(start, end) {
            // Filter Transactions
            currentFilteredTransactions = transactions.filter(t => {
                const d = new Date(t.date);
                // Reset time part for accurate date comparison
                d.setHours(0, 0, 0, 0);
                const s = new Date(start); s.setHours(0, 0, 0, 0);
                const e = new Date(end); e.setHours(23, 59, 59, 999);
                return d >= s && d <= e;
            });

            // Calculate Totals
            const income = currentFilteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = currentFilteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            document.getElementById('analytics-income').textContent = formatCurrency(income);
            document.getElementById('analytics-expense').textContent = formatCurrency(expense);
            document.getElementById('analytics-balance').textContent = formatCurrency(balance);

            updateCharts(currentFilteredTransactions);
        }

        function updateCharts(data) {
            // 1. Expense Breakdown
            const expenseData = {};
            data.filter(t => t.type === 'expense').forEach(t => {
                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
            });

            const ctx1 = document.getElementById('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();

            expenseChartInstance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseData),
                    datasets: [{
                        data: Object.values(expenseData),
                        backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } }
                    }
                }
            });

            // 2. Trend (Income vs Expense)
            // Group by Date
            const dateMap = {};
            data.forEach(t => {
                const d = new Date(t.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                if (!dateMap[d]) dateMap[d] = { income: 0, expense: 0 };
                if (t.type === 'income') dateMap[d].income += t.amount;
                else dateMap[d].expense += t.amount;
            });

            // Sort dates
            const sortedDates = Object.keys(dateMap).sort((a, b) => new Date(a) - new Date(b));

            const ctx2 = document.getElementById('trendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [
                        { label: 'Income', data: sortedDates.map(d => dateMap[d].income), backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'Expense', data: sortedDates.map(d => dateMap[d].expense), backgroundColor: '#ef4444', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function exportAnalyticsReport() {
            // Reuse existing PDF container but populate with filtered data
            const pdfBody = document.getElementById('pdf-table-body');
            pdfBody.innerHTML = '';

            const income = currentFilteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = currentFilteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('pdf-date').textContent = `Report for ${document.getElementById('date-start').value || 'All Time'} to ${document.getElementById('date-end').value || 'Now'}`;
            document.getElementById('pdf-income').textContent = formatCurrency(income);
            document.getElementById('pdf-expense').textContent = formatCurrency(expense);
            document.getElementById('pdf-balance').textContent = formatCurrency(income - expense);

            currentFilteredTransactions.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100";
                const isInc = t.type === 'income';
                tr.innerHTML = `
                    <td class="py-2 text-gray-500">${new Date(t.date).toLocaleDateString()}</td>
                    <td class="py-2 font-medium">${t.description}</td>
                    <td class="py-2 text-gray-500">${t.category}</td>
                    <td class="py-2 text-right font-bold ${isInc ? 'text-green-600' : 'text-red-600'}">
                        ${isInc ? '+' : '-'}${formatCurrency(t.amount)}
                    </td>
                `;
                pdfBody.appendChild(tr);
            });

            const element = document.getElementById('pdf-container');
            element.classList.remove('hidden');

            const opt = {
                margin: 0.5,
                filename: `Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.add('hidden');
            });
        }
    </script>
</body>

</html>