<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket Finance</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pocket Finance">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        success: '#10b981',
                        danger: '#ef4444',
                        bg: '#f8fafc',
                        card: '#ffffff'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Safe Area adjustments */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input,
        select {
            font-size: 16px !important;
        }

        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }

        .transaction-card.selected {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .transaction-card.selected .action-buttons {
            background: linear-gradient(to left, #dbeafe, #dbeafe 70%, transparent) !important;
            border-radius: 0 1rem 1rem 0;
        }

        /* Privacy Mode */
        body.privacy-active .privacy-sensitive {
            filter: blur(6px) !important;
            cursor: default;
            user-select: none;
        }
    </style>
</head>

<body class="bg-bg text-slate-800 h-screen flex flex-col overflow-hidden">

    <header class="px-6 pt-6 pb-4 bg-white shadow-sm z-10 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Pocket Finance</h1>
            <p class="text-xs text-slate-500" id="current-date">Loading...</p>
        </div>
        <div class="flex gap-3 items-center">
            <button id="login-btn" onclick="googleLogin()"
                class="hidden bg-white border border-slate-200 text-slate-600 px-3 h-10 rounded-full flex items-center gap-2 text-xs font-bold hover:bg-slate-50 transition">
                <i class="fa-brands fa-google text-red-500"></i> Sync
            </button>

            <button onclick="toggleAnalytics()"
                class="bg-slate-100 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition">
                <i class="fa-solid fa-chart-pie"></i>
            </button>

            <div class="relative">
                <button onclick="toggleMoreMenu()"
                    class="bg-slate-100 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>

                <div id="more-menu"
                    class="hidden absolute top-12 right-0 bg-white shadow-xl rounded-xl p-1 z-50 min-w-[180px] border border-slate-100">
                    <button id="encryption-menu-item" onclick="openEncryptionSettings(); toggleMoreMenu();"
                        class="hidden w-full text-left text-sm text-slate-700 font-medium hover:bg-slate-50 px-3 py-2.5 rounded-lg transition flex items-center gap-3">
                        <span id="encryption-icon"
                            class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                            <i class="fa-solid fa-lock text-xs"></i>
                        </span>
                        Encryption
                    </button>
                    <button onclick="openCategorySettings(); toggleMoreMenu();"
                        class="w-full text-left text-sm text-slate-700 font-medium hover:bg-slate-50 px-3 py-2.5 rounded-lg transition flex items-center gap-3">
                        <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center">
                            <i class="fa-solid fa-gear text-xs"></i>
                        </span>
                        Categories
                    </button>
                    <button onclick="openAccountsModal(); toggleMoreMenu();"
                        class="w-full text-left text-sm text-slate-700 font-medium hover:bg-slate-50 px-3 py-2.5 rounded-lg transition flex items-center gap-3">
                        <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center">
                            <i class="fa-solid fa-wallet text-xs"></i>
                        </span>
                        Accounts
                    </button>
                </div>
            </div>

            <div id="user-profile" class="hidden relative flex items-center gap-2">
                <img id="user-avatar" src="" onclick="toggleProfileMenu()"
                    class="w-10 h-10 rounded-full border-2 border-white shadow-sm cursor-pointer hover:scale-105 transition"
                    alt="User">

                <div id="profile-menu"
                    class="hidden absolute top-12 right-0 bg-white shadow-xl rounded-xl p-1 z-50 min-w-[140px] border border-slate-100 animate-in fade-in slide-in-from-top-2 duration-200">
                    <button onclick="googleLogout()"
                        class="w-full text-left text-sm text-red-500 font-medium hover:bg-red-50 px-3 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative" id="main-container">
        <!-- Pull to Refresh Indicator -->
        <div id="pull-indicator"
            class="absolute top-0 left-0 right-0 flex justify-center items-center transition-all duration-200 -translate-y-full opacity-0 z-10">
            <div class="bg-white rounded-full shadow-lg p-2 flex items-center gap-2">
                <i id="pull-icon" class="fa-solid fa-arrows-rotate text-primary text-sm"></i>
                <span id="pull-text" class="text-xs font-medium text-slate-600">Pull to refresh</span>
            </div>
        </div>
        <div
            class="bg-gradient-to-br from-primary to-blue-600 rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
            <div
                class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl pointer-events-none">
            </div>
            <div class="flex justify-between items-center mb-1 relative z-10">
                <p class="text-blue-100 text-sm font-medium">Total Balance</p>
                <button onclick="togglePrivacy()"
                    class="w-8 h-8 rounded-full flex items-center justify-center text-blue-100 hover:text-white hover:bg-white/10 transition">
                    <i class="fa-solid fa-eye" id="privacy-icon"></i>
                </button>
            </div>
            <h2 class="text-3xl font-bold tracking-tight mb-4 privacy-sensitive" id="total-balance">₹0.00</h2>
            <div class="flex gap-4">
                <div class="flex-1 bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-5 h-5 rounded-full bg-green-400/30 flex items-center justify-center">
                            <i class="fa-solid fa-arrow-down text-green-300 text-[10px]"></i>
                        </div>
                        <span class="text-xs text-blue-50">Income</span>
                    </div>
                    <p class="font-semibold text-lg privacy-sensitive" id="total-income">₹0.00</p>
                </div>
                <div class="flex-1 bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-5 h-5 rounded-full bg-red-400/30 flex items-center justify-center">
                            <i class="fa-solid fa-arrow-up text-red-300 text-[10px]"></i>
                        </div>
                        <span class="text-xs text-blue-50">Expense</span>
                    </div>
                    <p class="font-semibold text-lg privacy-sensitive" id="total-expense">₹0.00</p>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-3 px-1">
            <div class="flex items-center gap-2">
                <h3 class="font-bold text-base text-slate-800">Transactions</h3>
                <button onclick="refreshApp()" id="refresh-btn"
                    class="w-7 h-7 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 active:scale-90 transition"
                    title="Refresh">
                    <i class="fa-solid fa-arrows-rotate text-xs"></i>
                </button>
            </div>
            <div class="flex gap-1 items-center">
                <span id="active-filter-badge"
                    class="hidden text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-medium"></span>
                <button id="clear-filter-btn" onclick="clearFilters()"
                    class="hidden w-5 h-5 rounded-full bg-red-100 text-red-500 flex items-center justify-center hover:bg-red-200 active:scale-90 transition"
                    title="Clear Filters">
                    <i class="fa-solid fa-xmark text-[10px]"></i>
                </button>
                <button onclick="toggleFilterPanel()"
                    class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 active:scale-90 transition"
                    title="Filters">
                    <i class="fa-solid fa-filter text-xs"></i>
                </button>
            </div>
        </div>

        <!-- Filter Panel (Hidden by default) -->
        <div id="filter-panel" class="hidden bg-white rounded-xl shadow-lg border border-slate-100 p-4 mb-4 mx-1">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold text-sm text-slate-700">Filters</h4>
                <button onclick="clearFilters()" class="text-xs text-blue-600 font-medium hover:underline">Clear
                    All</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-[10px] font-semibold text-slate-500 uppercase mb-1">Account</label>
                    <select id="filter-account" onchange="renderUI(); updateFilterBadge();"
                        class="w-full bg-slate-50 border border-slate-200 text-slate-600 text-xs font-medium rounded-lg px-2 py-2 focus:outline-none">
                        <option value="all">All Accounts</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-semibold text-slate-500 uppercase mb-1">Type</label>
                    <select id="filter-type" onchange="renderUI(); updateFilterBadge();"
                        class="w-full bg-slate-50 border border-slate-200 text-slate-600 text-xs font-medium rounded-lg px-2 py-2 focus:outline-none">
                        <option value="all">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-semibold text-slate-500 uppercase mb-1">From Date</label>
                    <input type="date" id="filter-date-start" onchange="renderUI(); updateFilterBadge();"
                        class="w-full bg-slate-50 border border-slate-200 text-slate-600 text-xs font-medium rounded-lg px-2 py-2 focus:outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-semibold text-slate-500 uppercase mb-1">To Date</label>
                    <input type="date" id="filter-date-end" onchange="renderUI(); updateFilterBadge();"
                        class="w-full bg-slate-50 border border-slate-200 text-slate-600 text-xs font-medium rounded-lg px-2 py-2 focus:outline-none">
                </div>
            </div>
            <button onclick="toggleFilterPanel()"
                class="w-full mt-3 bg-primary text-white font-bold py-2 rounded-lg text-sm">Apply Filters</button>
        </div>


        <div id="empty-state" class="hidden flex-col items-center justify-center py-12 text-slate-400">
            <i class="fa-solid fa-receipt text-4xl mb-3 opacity-50"></i>
            <p class="text-sm">No transactions yet.</p>
        </div>

        <div id="transaction-list" class="space-y-3"></div>
    </main>

    <div class="fixed bottom-6 right-6 z-20">
        <button onclick="openAddModal()"
            class="w-14 h-14 bg-primary text-white rounded-full shadow-xl shadow-blue-500/40 flex items-center justify-center text-2xl hover:bg-blue-700 active:scale-90 transition">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div id="add-modal" class="modal fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4 sm:p-0">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleModal('add-modal')"></div>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative shadow-2xl z-10 mb-4 sm:mb-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="modal-title">New Transaction</h3>
                <button onclick="toggleModal('add-modal')" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <form id="transaction-form" onsubmit="addTransaction(event)">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">₹</span>
                        <input type="number" id="amount" step="0.01" inputmode="decimal" required
                            class="w-full pl-8 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary text-lg font-semibold"
                            placeholder="0.00">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Date</label>
                    <input type="date" id="transaction-date" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary text-lg font-semibold">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Description <span
                            class="text-slate-300 font-normal lowercase">(optional)</span></label>
                    <input type="text" id="description"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"
                        placeholder="e.g. Groceries">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Type</label>
                        <select id="type" onchange="updateCategories()"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary appearance-none">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                            <option value="transfer">Transfer</option>
                        </select>
                    </div>
                    <div id="category-container">
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Category</label>
                        <select id="category"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary appearance-none"></select>
                    </div>
                </div>

                <div class="mb-4 hidden" id="to-account-wrapper">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">To Account</label>
                    <div class="relative">
                        <select id="to-account"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary appearance-none">
                            <!-- Populated by JS -->
                        </select>
                        <i
                            class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <div class="mb-6">
                    <label id="account-label"
                        class="block text-xs font-semibold text-slate-500 uppercase mb-1">Account</label>
                    <select id="transaction-account"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary appearance-none"></select>
                </div>

                <button type="submit" id="submit-btn"
                    class="w-full bg-primary text-white font-bold py-4 rounded-xl hover:bg-blue-700 active:scale-95 transition shadow-lg shadow-blue-500/30">Add
                    Transaction</button>
            </form>
        </div>
    </div>

    <div id="pin-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 relative shadow-2xl z-10">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-100 text-primary rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-shield-halved"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Enter Security PIN</h3>
                <p class="text-xs text-slate-500 mt-2">Your data is encrypted. Enter your 6-digit PIN to unlock it.</p>
            </div>

            <form onsubmit="submitPin(event)">
                <input type="password" id="pin-input" maxlength="6" inputmode="numeric" pattern="[0-9]*"
                    class="w-full text-center text-2xl tracking-[0.5em] font-bold py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-6"
                    placeholder="••••••" autofocus>

                <button type="submit"
                    class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:bg-blue-700 active:scale-95 transition">
                    Unlock Data
                </button>
            </form>
            <button onclick="googleLogout()" class="w-full mt-3 text-sm text-slate-400 hover:text-red-500">Cancel &
                Logout</button>
        </div>
    </div>

    <div id="category-settings-modal"
        class="modal fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4 sm:p-0">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleModal('category-settings-modal')">
        </div>
        <div
            class="bg-white w-full max-w-md rounded-2xl p-6 relative shadow-2xl z-10 mb-4 sm:mb-0 max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Manage Categories</h3>
                <button onclick="toggleModal('category-settings-modal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex gap-2 mb-6 border-b border-slate-200">
                <button id="tab-expense" onclick="switchCategoryTab('expense')"
                    class="flex-1 px-4 py-2 text-sm font-bold text-primary border-b-2 border-primary">Expense</button>
                <button id="tab-income" onclick="switchCategoryTab('income')"
                    class="flex-1 px-4 py-2 text-sm font-bold text-slate-400 border-b-2 border-transparent">Income</button>
            </div>
            <div id="expense-categories-section" class="category-section">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Expense Categories</label>
                    <div id="expense-categories-list" class="space-y-2 mb-3 max-h-64 overflow-y-auto no-scrollbar">
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="new-expense-category" placeholder="New category name"
                            class="flex-1 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                        <button onclick="addCategory('expense')"
                            class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold"><i
                                class="fa-solid fa-plus"></i> Add</button>
                    </div>
                </div>
                <button onclick="resetCategories('expense')"
                    class="w-full bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold"><i
                        class="fa-solid fa-rotate-right"></i> Reset to Defaults</button>
            </div>
            <div id="income-categories-section" class="category-section hidden">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Income Categories</label>
                    <div id="income-categories-list" class="space-y-2 mb-3 max-h-64 overflow-y-auto no-scrollbar"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-income-category" placeholder="New category name"
                            class="flex-1 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                        <button onclick="addCategory('income')"
                            class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold"><i
                                class="fa-solid fa-plus"></i> Add</button>
                    </div>
                </div>
                <button onclick="resetCategories('income')"
                    class="w-full bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold"><i
                        class="fa-solid fa-rotate-right"></i> Reset to Defaults</button>
            </div>
        </div>
    </div>

    <!-- Accounts Management Modal -->
    <div id="accounts-modal" class="modal fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4 sm:p-0">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleModal('accounts-modal')">
        </div>
        <div
            class="bg-white w-full max-w-md rounded-2xl p-6 relative shadow-2xl z-10 mb-4 sm:mb-0 max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Manage Accounts</h3>
                <button onclick="toggleModal('accounts-modal')" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <!-- Account List -->
            <div class="mb-4">
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Your Accounts</label>
                <div id="accounts-list" class="space-y-2 mb-3 max-h-64 overflow-y-auto no-scrollbar"></div>
            </div>

            <!-- Add/Edit Account Form -->
            <div id="account-form-section" class="bg-slate-50 rounded-xl p-4 mb-4">
                <h4 id="account-form-title" class="text-sm font-bold text-slate-700 mb-3">Add New Account</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Account Name</label>
                        <input type="text" id="account-name" placeholder="e.g. HDFC Savings"
                            class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Account Type</label>
                        <select id="account-type"
                            class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary appearance-none">
                            <option value="bank">Bank Account</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="upi">UPI (Paytm, GPay, etc.)</option>
                            <option value="cash">Cash / Wallet</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="cancelAccountEdit()" id="cancel-account-btn"
                        class="hidden flex-1 bg-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold">Cancel</button>
                    <button onclick="saveAccount()" id="save-account-btn"
                        class="flex-1 bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold"><i
                            class="fa-solid fa-plus mr-1"></i> Add Account</button>
                </div>
            </div>
        </div>
    </div>

    <div id="analytics-modal" class="modal fixed inset-0 z-50 flex flex-col bg-bg overflow-hidden">

        <div class="bg-white px-6 py-4 shadow-sm flex justify-between items-center z-10">
            <h2 class="text-xl font-bold text-slate-900">Analytics</h2>
            <button onclick="toggleAnalytics()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-6">
                <!-- Analytics Account Filter -->
                <div class="mb-4">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Filter by Account</label>
                    <select id="analytics-account"
                        onchange="const dS = document.getElementById('date-start').value; const dE = document.getElementById('date-end').value; renderAnalytics(new Date(dS), new Date(dE));"
                        class="w-full bg-slate-50 border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-3 py-2 focus:outline-none">
                        <option value="all">All Accounts</option>
                    </select>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="setFilter('thisMonth')"
                        class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-primary text-white whitespace-nowrap"
                        id="btn-thisMonth">This Month</button>
                    <button onclick="setFilter('lastMonth')"
                        class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-500 whitespace-nowrap"
                        id="btn-lastMonth">Last Month</button>
                    <button onclick="setFilter('all')"
                        class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-500 whitespace-nowrap"
                        id="btn-all">All Time</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Start</label><input type="date"
                            id="date-start" onchange="customDateFilter()"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-xs font-semibold">
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">End</label><input type="date"
                            id="date-end" onchange="customDateFilter()"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-xs font-semibold">
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-6">
                <div class="bg-green-50 p-3 rounded-xl border border-green-100">
                    <p class="text-[10px] text-green-600 font-bold uppercase mb-1">Income</p>
                    <p class="text-sm font-bold text-green-700" id="analytics-income">₹0</p>
                </div>
                <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                    <p class="text-[10px] text-red-600 font-bold uppercase mb-1">Expense</p>
                    <p class="text-sm font-bold text-red-700" id="analytics-expense">₹0</p>
                </div>
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold uppercase mb-1">Balance</p>
                    <p class="text-sm font-bold text-blue-700" id="analytics-balance">₹0</p>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-6">
                <h3 class="font-bold text-slate-800 mb-4 text-sm">Expense Breakdown</h3>
                <div class="h-64 relative"><canvas id="expenseChart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-24">
                <h3 class="font-bold text-slate-800 mb-4 text-sm">Income vs Expense</h3>
                <div class="h-48 relative"><canvas id="trendChart"></canvas></div>
            </div>
        </div>
        <div class="absolute bottom-6 left-0 right-0 px-6 flex justify-center">
            <button onclick="exportAnalyticsReport()"
                class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 font-bold text-sm hover:bg-slate-900 active:scale-95 transition"><i
                    class="fa-solid fa-file-export"></i> Export Report</button>
        </div>
    </div>

    <div id="pdf-container" class="hidden bg-white p-8">
        <h1 class="text-2xl font-bold mb-2 text-center">Financial Report</h1>
        <p class="text-center text-gray-500 text-sm mb-6" id="pdf-date"></p>
        <div class="grid grid-cols-3 gap-4 mb-6 border-b pb-6">
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Income</p>
                <p class="text-green-600 font-bold text-lg" id="pdf-income"></p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Expenses</p>
                <p class="text-red-600 font-bold text-lg" id="pdf-expense"></p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Net Balance</p>
                <p class="text-blue-600 font-bold text-lg" id="pdf-balance"></p>
            </div>
        </div>
        <table class="w-full text-left text-sm">
            <thead>
                <tr class="border-b-2 border-gray-200">
                    <th class="py-2">Date</th>
                    <th class="py-2">Description</th>
                    <th class="py-2">Category</th>
                    <th class="py-2 text-right">Amount</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body"></tbody>
        </table>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 relative shadow-2xl z-10">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-trash"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Delete Transaction?</h3>
                <p class="text-sm text-slate-500 mt-2">This action cannot be undone. Are you sure you want to delete
                    this transaction?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()"
                    class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 active:scale-95 transition">Cancel</button>
                <button onclick="confirmDelete()"
                    class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 active:scale-95 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- Set PIN Modal -->
    <div id="set-pin-modal" class="modal fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeSetPinModal()"></div>
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 relative shadow-2xl z-10">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-shield-halved"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Set Security PIN</h3>
                <p class="text-sm text-slate-500 mt-2">Create a 4-6 digit PIN for End-to-End Encryption</p>
            </div>
            <div class="space-y-4 mb-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Enter PIN</label>
                    <input type="password" id="new-pin-input" maxlength="6" inputmode="numeric" pattern="[0-9]*"
                        class="w-full text-center text-2xl tracking-[0.5em] font-bold py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="••••••">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Confirm PIN</label>
                    <input type="password" id="confirm-pin-input" maxlength="6" inputmode="numeric" pattern="[0-9]*"
                        class="w-full text-center text-2xl tracking-[0.5em] font-bold py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="••••••">
                </div>
                <p id="pin-error" class="text-red-500 text-xs text-center hidden"></p>
            </div>
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-4">
                <p class="text-xs text-amber-700"><i class="fa-solid fa-triangle-exclamation mr-1"></i>
                    <strong>Warning:</strong> If you forget this PIN, your data cannot be recovered. There is no reset
                    option.
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSetPinModal()"
                    class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 active:scale-95 transition">Cancel</button>
                <button onclick="confirmSetPin()"
                    class="flex-1 bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 active:scale-95 transition">Enable</button>
            </div>
        </div>
    </div>


    <div id="encryption-status-modal" class="modal fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeEncryptionStatusModal()"></div>
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 relative shadow-2xl z-10">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-shield-halved"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Encryption Active</h3>
                <p class="text-sm text-slate-500 mt-2">You are using PIN-based End-to-End Encryption. Your data is safe.
                </p>
            </div>
            <button onclick="closeEncryptionStatusModal()"
                class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 active:scale-95 transition">OK</button>
        </div>
    </div>

    <div id="encryption-confirm-modal" class="modal fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeEncryptionConfirmModal()"></div>
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 relative shadow-2xl z-10">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-100 text-primary rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Enhance Security?</h3>
                <p class="text-sm text-slate-500 mt-2">You are currently using Standard Security (UID). Switch to
                    End-to-End Encryption (PIN)? This makes data unreadable to anyone but you.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeEncryptionConfirmModal()"
                    class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 active:scale-95 transition">Cancel</button>
                <button onclick="proceedToPinSetup()"
                    class="flex-1 bg-primary text-white font-bold py-3 rounded-xl hover:bg-blue-700 active:scale-95 transition">Enable</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDaGRXYekB8nSGD6RfMJMuJD_h5cogmSbE",
            authDomain: "my-finance-tracker-yuva.firebaseapp.com",
            projectId: "my-finance-tracker-yuva",
            storageBucket: "my-finance-tracker-yuva.firebasestorage.app",
            messagingSenderId: "230460049894",
            appId: "1:230460049894:web:0a26d8c5503805a2b72e27",
            measurementId: "G-HM2JXMVZ9T"
        };

        let auth, db, currentUser = null;
        let isFirebaseReady = false;

        // --- ENCRYPTION VARIABLES ---
        let userEncryptionKey = null; // Can be UID or PIN
        let usingPin = false;         // Tracks if we are in PIN mode or UID mode

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;

            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateAuthUI(user);
                if (user) {
                    checkEncryptionMode(user);
                } else {
                    userEncryptionKey = null;
                    usingPin = false;
                    loadFromLocal();
                }
            });
        } catch (e) {
            console.error("Firebase Error:", e);
        }

        // --- Data & State ---
        let transactions = [];
        let editingTransactionId = null;
        let cloudUnsubscribe = null;
        const defaultCategories = {
            expense: ['Food', 'Transport', 'Shopping', 'Bills', 'Health', 'Entertainment', 'Investment', 'Other'],
            income: ['Salary', 'Gift', 'Other']
        };
        let categories = { expense: [...defaultCategories.expense], income: [...defaultCategories.income] };

        // --- Privacy State ---
        let privacyMode = localStorage.getItem('privacyMode') === 'true';
        if (privacyMode) document.body.classList.add('privacy-active');

        const iconMap = { 'Food': 'fa-utensils', 'Transport': 'fa-car', 'Shopping': 'fa-bag-shopping', 'Bills': 'fa-file-invoice-dollar', 'Health': 'fa-heart-pulse', 'Entertainment': 'fa-film', 'Salary': 'fa-money-bill-wave', 'Gift': 'fa-gift', 'Investment': 'fa-chart-line', 'Other': 'fa-circle-question' };

        // --- Accounts State ---
        const defaultAccount = { id: 'default', name: 'Main Account', type: 'bank', createdAt: new Date().toISOString() };
        let accounts = [{ ...defaultAccount }];
        let editingAccountId = null;
        const accountTypeIcons = {
            'cash': 'fa-money-bill',
            'bank': 'fa-building-columns',
            'credit_card': 'fa-credit-card',
            'upi': 'fa-mobile-screen',
            'other': 'fa-wallet'
        };
        const accountTypeLabels = {
            'cash': 'Cash / Wallet',
            'bank': 'Bank Account',
            'credit_card': 'Credit Card',
            'upi': 'UPI',
            'other': 'Other'
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', month: 'long', day: 'numeric' });
            loadCategories();
            loadAccounts();
            loadFilters();
            updateCategories();
            updateAccountSelectors();
            updatePrivacyIcon();
            if (!currentUser) loadFromLocal();
        });


        // ==========================================
        // ENCRYPTION LOGIC (CORE FEATURES)
        // ==========================================

        async function checkEncryptionMode(user) {
            // Check if this user has enabled PIN mode in Firestore
            try {
                const settingsDoc = await db.collection('users').doc(user.uid).collection('settings').doc('security').get();

                if (settingsDoc.exists && settingsDoc.data().usePin) {
                    // PIN MODE ENABLED
                    const savedPin = localStorage.getItem('user_privacy_pin');
                    if (savedPin) {
                        // Found in storage, use it silently
                        userEncryptionKey = savedPin;
                        usingPin = true;
                        updateLockIcon(true);
                        syncLocalToCloud();
                    } else {
                        // Not found locally, MUST ASK USER
                        toggleModal('pin-modal');
                        // Notice: We do NOT call sync/load yet, wait for PIN
                    }
                } else {
                    // DEFAULT MODE (Use UID)
                    userEncryptionKey = user.uid;
                    usingPin = false;
                    updateLockIcon(false);
                    syncLocalToCloud();
                }
            } catch (error) {
                console.error("Error checking encryption mode", error);
                // Fallback to UID default
                userEncryptionKey = user.uid;
                usingPin = false;
                syncLocalToCloud();
            }
        }

        function submitPin(e) {
            e.preventDefault();
            const pin = document.getElementById('pin-input').value;
            if (pin.length >= 4 && pin.length <= 6) {
                userEncryptionKey = pin;
                usingPin = true;
                localStorage.setItem('user_privacy_pin', pin); // Save for next time
                toggleModal('pin-modal');
                updateLockIcon(true);
                syncLocalToCloud();
            } else {
                alert("Please enter your PIN (4-6 digits)");
            }
        }

        function encryptData(dataObject) {
            if (!userEncryptionKey) return dataObject;

            // Serialize
            const jsonString = JSON.stringify(dataObject);
            // Encrypt using current key (UID or PIN)
            const encrypted = CryptoJS.AES.encrypt(jsonString, userEncryptionKey).toString();

            return {
                isEncrypted: true,
                payload: encrypted,
                date: dataObject.date // Keep date visible for sorting
            };
        }

        function decryptData(docData) {
            if (!docData.isEncrypted) return docData; // Legacy data support

            // Helper to try decrypting with a specific key
            const tryKey = (key) => {
                if (!key) return null;
                try {
                    const bytes = CryptoJS.AES.decrypt(docData.payload, key);
                    const utf8 = bytes.toString(CryptoJS.enc.Utf8);
                    if (!utf8) throw new Error("Empty decryption result");
                    return JSON.parse(utf8);
                } catch (e) {
                    return null;
                }
            };

            // 1. Try Current Key (PIN or default UID)
            let result = tryKey(userEncryptionKey);
            if (result) return result;

            // 2. Fallback: Try UID (if we are currently using a different key like PIN)
            if (currentUser && userEncryptionKey !== currentUser.uid) {
                result = tryKey(currentUser.uid);
                if (result) return result;
            }

            console.error("Decryption failed with all available keys.");
            return null;
        }

        function enablePinEncryption() {
            // Open set PIN modal
            document.getElementById('new-pin-input').value = '';
            document.getElementById('confirm-pin-input').value = '';
            document.getElementById('pin-error').classList.add('hidden');
            toggleModal('set-pin-modal');
        }

        function closeSetPinModal() {
            toggleModal('set-pin-modal');
        }

        function confirmSetPin() {
            const pin = document.getElementById('new-pin-input').value;
            const confirmPin = document.getElementById('confirm-pin-input').value;
            const errorEl = document.getElementById('pin-error');

            // Validation
            if (!/^\d{4,6}$/.test(pin)) {
                errorEl.textContent = 'PIN must be 4-6 digits';
                errorEl.classList.remove('hidden');
                return;
            }

            if (pin !== confirmPin) {
                errorEl.textContent = 'PINs do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            // 1. Save setting to Firestore
            db.collection('users').doc(currentUser.uid).collection('settings').doc('security').set({ usePin: true });

            // 2. Save PIN locally
            localStorage.setItem('user_privacy_pin', pin);

            // 3. Update State
            userEncryptionKey = pin;
            usingPin = true;
            updateLockIcon(true);

            // 4. Close modal
            toggleModal('set-pin-modal');

            // 5. Show success (using a simple approach)
            showToast('🔒 End-to-End Encryption enabled!');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl z-[100] animate-pulse';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateLockIcon(isSecure) {
            const menuItem = document.getElementById('encryption-menu-item');
            const iconSpan = document.getElementById('encryption-icon');
            menuItem.classList.remove('hidden');

            if (isSecure) {
                iconSpan.className = "w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center";
                iconSpan.innerHTML = '<i class="fa-solid fa-lock text-xs"></i>';
            } else {
                // Warning icon indicating default security (UID based)
                iconSpan.className = "w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center";
                iconSpan.innerHTML = '<i class="fa-solid fa-lock-open text-xs"></i>';
            }
        }

        function openEncryptionSettings() {
            if (usingPin) {
                toggleModal('encryption-status-modal');
            } else {
                toggleModal('encryption-confirm-modal');
            }
        }

        function closeEncryptionStatusModal() {
            toggleModal('encryption-status-modal');
        }

        function closeEncryptionConfirmModal() {
            toggleModal('encryption-confirm-modal');
        }

        function proceedToPinSetup() {
            closeEncryptionConfirmModal();
            enablePinEncryption();
        }

        function promptToUnlock() {
            // Open the existing PIN input modal (used for login unlock)
            // Clear input first
            document.getElementById('pin-input').value = '';
            toggleModal('pin-modal');
        }

        // --- Auth Functions ---
        function googleLogin() {
            if (!isFirebaseReady) return alert("Configure Firebase first.");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert(e.message));
        }

        function googleLogout() {
            localStorage.removeItem('user_privacy_pin'); // Clear PIN on logout
            auth.signOut();
            transactions = [];
            document.getElementById('pin-input').value = ''; // Clear modal input
            loadFromLocal();
        }

        function updateAuthUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userProfile = document.getElementById('user-profile');
            const avatar = document.getElementById('user-avatar');
            const encryptionItem = document.getElementById('encryption-menu-item');

            if (user) {
                loginBtn.classList.add('hidden');
                loginBtn.classList.remove('flex');
                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                avatar.src = user.photoURL;
                encryptionItem.classList.remove('hidden');
                encryptionItem.classList.add('flex');
            } else {
                loginBtn.classList.remove('hidden');
                loginBtn.classList.add('flex');
                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
                encryptionItem.classList.add('hidden');
                encryptionItem.classList.remove('flex');
            }
        }

        // --- Storage Logic ---
        function loadFromLocal() {
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            renderUI();
        }

        function loadFromCloud() {
            if (!currentUser) return;

            // Unsubscribe previous listener to prevent duplicates/leaks
            if (cloudUnsubscribe) {
                cloudUnsubscribe();
            }

            cloudUnsubscribe = db.collection('users').doc(currentUser.uid).collection('transactions')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    const loaded = [];
                    let decryptionFailed = false;

                    snapshot.docs.forEach(doc => {
                        const raw = doc.data();

                        // DECRYPTION STEP
                        let finalData = raw;
                        if (raw.isEncrypted) {
                            const decrypted = decryptData(raw);
                            if (decrypted) {
                                finalData = decrypted;
                            } else {
                                // Decryption failed
                                decryptionFailed = true;
                                finalData = {
                                    description: "🔒 Encrypted Data (Check PIN)",
                                    amount: 0,
                                    type: 'expense',
                                    category: 'Other',
                                    date: raw.date || new Date().toISOString(),
                                    isLocked: true
                                };
                            }
                        }

                        loaded.push({ id: doc.id, ...finalData });
                    });
                    transactions = loaded;
                    renderUI();

                    // Auto-prompt if data is locked and we aren't already asking
                    if (decryptionFailed) {
                        if (!usingPin) {
                            // Only prompt if we haven't tried a PIN yet (default state)
                            const modal = document.getElementById('pin-modal');
                            if (modal && !modal.classList.contains('active')) {
                                promptToUnlock();
                            }
                        } else {
                            // We used a PIN but it failed -> Wrong PIN
                            showToast('Decryption failed. Incorrect PIN?');
                        }
                    }
                });
        }

        async function syncLocalToCloud() {
            if (!currentUser || !isFirebaseReady) return;
            const localTransactions = JSON.parse(localStorage.getItem('transactions')) || [];

            if (localTransactions.length === 0) {
                loadFromCloud();
                return;
            }

            try {
                // Batch processing (limit 500 per batch)
                const chunkSize = 400;
                for (let i = 0; i < localTransactions.length; i += chunkSize) {
                    const chunk = localTransactions.slice(i, i + chunkSize);
                    const batch = db.batch();

                    chunk.forEach(tx => {
                        const { id, ...data } = tx;
                        const dataToSave = encryptData(data);
                        const docRef = db.collection('users').doc(currentUser.uid).collection('transactions').doc(String(id));
                        batch.set(docRef, dataToSave);
                    });

                    await batch.commit();
                }

                localStorage.removeItem('transactions');
                loadFromCloud();
                showToast('Sync Complete!');
            } catch (error) {
                console.error('Sync Error:', error);
                loadFromCloud();
            }
        }

        function saveData(newTx = null, deleteId = null) {
            if (currentUser && isFirebaseReady) {
                if (newTx) {
                    const { id, ...data } = newTx;
                    // ENCRYPT BEFORE SAVE
                    const dataToSave = encryptData(data);
                    db.collection('users').doc(currentUser.uid).collection('transactions').doc(String(newTx.id)).set(dataToSave);
                }
                if (deleteId) {
                    db.collection('users').doc(currentUser.uid).collection('transactions').doc(String(deleteId)).delete();
                }
            } else {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                renderUI();
            }
        }

        // --- Categories (Standard Logic) ---
        function loadCategories() {
            const saved = localStorage.getItem('categories');
            if (saved) categories = JSON.parse(saved);
            if (currentUser && isFirebaseReady) {
                db.collection('users').doc(currentUser.uid).collection('settings').doc('categories').get()
                    .then(doc => {
                        if (doc.exists && doc.data().categories) {
                            categories = doc.data().categories;
                            updateCategories();
                        }
                    });
            }
        }
        function saveCategories() {
            localStorage.setItem('categories', JSON.stringify(categories));
            if (currentUser && isFirebaseReady) {
                db.collection('users').doc(currentUser.uid).collection('settings').doc('categories').set({ categories, updatedAt: new Date().toISOString() });
            }
            updateCategories();
        }
        function openCategorySettings() { renderCategoryList('expense'); renderCategoryList('income'); switchCategoryTab('expense'); toggleModal('category-settings-modal'); }
        function switchCategoryTab(type) {
            document.getElementById('tab-expense').className = type === 'expense' ? 'flex-1 px-4 py-2 text-sm font-bold text-primary border-b-2 border-primary' : 'flex-1 px-4 py-2 text-sm font-bold text-slate-400 border-b-2 border-transparent';
            document.getElementById('tab-income').className = type === 'income' ? 'flex-1 px-4 py-2 text-sm font-bold text-primary border-b-2 border-primary' : 'flex-1 px-4 py-2 text-sm font-bold text-slate-400 border-b-2 border-transparent';
            document.getElementById('expense-categories-section').classList.toggle('hidden', type !== 'expense');
            document.getElementById('income-categories-section').classList.toggle('hidden', type !== 'income');
        }
        function renderCategoryList(type) {
            const list = document.getElementById(type === 'expense' ? 'expense-categories-list' : 'income-categories-list');
            list.innerHTML = '';
            categories[type].forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-slate-50 px-3 py-2 rounded-lg group hover:bg-slate-100 transition';
                item.innerHTML = `<span class="text-sm font-medium text-slate-700">${cat}</span><button onclick="removeCategory('${type}', '${cat}')" class="text-slate-400 hover:text-red-600 transition"><i class="fa-solid fa-trash text-xs"></i></button>`;
                list.appendChild(item);
            });
        }
        function addCategory(type) {
            const input = document.getElementById(type === 'expense' ? 'new-expense-category' : 'new-income-category');
            if (!input.value.trim() || categories[type].includes(input.value.trim())) return;
            categories[type].push(input.value.trim()); saveCategories(); renderCategoryList(type); input.value = '';
        }
        function removeCategory(type, cat) {
            if (categories[type].length <= 1 || cat === 'Other') return alert('Cannot remove');
            if (confirm(`Remove "${cat}"?`)) { categories[type] = categories[type].filter(c => c !== cat); saveCategories(); renderCategoryList(type); }
        }
        function resetCategories(type) { if (confirm("Reset defaults?")) { categories[type] = [...defaultCategories[type]]; saveCategories(); renderCategoryList(type); } }
        function updateCategories() {
            const type = document.getElementById('type').value;
            const catContainer = document.getElementById('category-container');
            const toAccWrapper = document.getElementById('to-account-wrapper');
            const accLabel = document.getElementById('account-label');

            if (type === 'transfer') {
                catContainer.classList.add('hidden');
                toAccWrapper.classList.remove('hidden');
                accLabel.textContent = "From Account";

                // Populate To Account
                const toSel = document.getElementById('to-account');
                toSel.innerHTML = '';
                accounts.forEach(acc => {
                    const o = document.createElement('option');
                    o.value = acc.id;
                    o.textContent = acc.name;
                    toSel.appendChild(o);
                });
            } else {
                catContainer.classList.remove('hidden');
                toAccWrapper.classList.add('hidden');
                accLabel.textContent = "Account";

                const sel = document.getElementById('category');
                sel.innerHTML = '';
                if (categories[type]) {
                    categories[type].forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
                }
            }
        }

        // --- Accounts Management ---
        function loadAccounts() {
            const saved = localStorage.getItem('accounts');
            if (saved) {
                accounts = JSON.parse(saved);
                // Ensure at least one account exists
                if (accounts.length === 0) accounts = [{ ...defaultAccount }];
            }
            if (currentUser && isFirebaseReady) {
                db.collection('users').doc(currentUser.uid).collection('settings').doc('accounts').get()
                    .then(doc => {
                        if (doc.exists && doc.data().accounts && doc.data().accounts.length > 0) {
                            accounts = doc.data().accounts;
                            updateAccountSelectors();
                        }
                    });
            }
        }

        function saveAccounts() {
            localStorage.setItem('accounts', JSON.stringify(accounts));
            if (currentUser && isFirebaseReady) {
                db.collection('users').doc(currentUser.uid).collection('settings').doc('accounts').set({
                    accounts,
                    updatedAt: new Date().toISOString()
                });
            }
            updateAccountSelectors();
        }

        function openAccountsModal() {
            renderAccountsList();
            cancelAccountEdit();
            toggleModal('accounts-modal');
        }

        function renderAccountsList() {
            const list = document.getElementById('accounts-list');
            list.innerHTML = '';
            accounts.forEach(acc => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white border border-slate-100 px-3 py-3 rounded-xl group hover:border-slate-200 transition';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                            <i class="fa-solid ${accountTypeIcons[acc.type] || 'fa-wallet'}"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-slate-800 text-sm">${acc.name}</h4>
                            <p class="text-xs text-slate-400">${accountTypeLabels[acc.type] || acc.type}</p>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editAccount('${acc.id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 hover:bg-blue-50 hover:text-blue-600 transition">
                            <i class="fa-solid fa-pen text-xs"></i>
                        </button>
                        <button onclick="deleteAccount('${acc.id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 hover:bg-red-50 hover:text-red-600 transition ${accounts.length <= 1 ? 'opacity-30 cursor-not-allowed' : ''}">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function saveAccount() {
            const name = document.getElementById('account-name').value.trim();
            const type = document.getElementById('account-type').value;

            if (!name) {
                showToast('Please enter an account name');
                return;
            }

            if (editingAccountId) {
                // Update existing account
                const idx = accounts.findIndex(a => a.id === editingAccountId);
                if (idx !== -1) {
                    accounts[idx].name = name;
                    accounts[idx].type = type;
                }
                showToast('Account updated!');
            } else {
                // Add new account
                const newAccount = {
                    id: 'acc_' + Date.now(),
                    name,
                    type,
                    createdAt: new Date().toISOString()
                };
                accounts.push(newAccount);
                showToast('Account added!');
            }

            saveAccounts();
            renderAccountsList();
            cancelAccountEdit();
        }

        function editAccount(id) {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;

            editingAccountId = id;
            document.getElementById('account-name').value = acc.name;
            document.getElementById('account-type').value = acc.type;
            document.getElementById('account-form-title').textContent = 'Edit Account';
            document.getElementById('save-account-btn').innerHTML = '<i class="fa-solid fa-check mr-1"></i> Update';
            document.getElementById('cancel-account-btn').classList.remove('hidden');
        }

        function cancelAccountEdit() {
            editingAccountId = null;
            document.getElementById('account-name').value = '';
            document.getElementById('account-type').value = 'bank';
            document.getElementById('account-form-title').textContent = 'Add New Account';
            document.getElementById('save-account-btn').innerHTML = '<i class="fa-solid fa-plus mr-1"></i> Add Account';
            document.getElementById('cancel-account-btn').classList.add('hidden');
        }

        function deleteAccount(id) {
            if (accounts.length <= 1) {
                showToast('You must have at least one account');
                return;
            }

            const acc = accounts.find(a => a.id === id);
            if (!acc) return;

            if (confirm(`Delete "${acc.name}"? Transactions linked to this account will be reassigned to your first account.`)) {
                const defaultAccId = accounts.find(a => a.id !== id)?.id || 'default';

                // Reassign transactions
                transactions.forEach(tx => {
                    if (tx.accountId === id) tx.accountId = defaultAccId;
                });

                accounts = accounts.filter(a => a.id !== id);
                saveAccounts();
                renderAccountsList();

                // Save updated transactions
                if (currentUser) {
                    // Re-save all transactions with updated accountIds
                    transactions.forEach(tx => saveData(tx, null));
                } else {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                }

                showToast('Account deleted');
                renderUI();
            }
        }

        function updateAccountSelectors() {
            const accSelect = document.getElementById('transaction-account');
            const filterSel = document.getElementById('filter-account');
            const analyticsSel = document.getElementById('analytics-account');

            [accSelect, filterSel, analyticsSel].forEach(sel => {
                if (!sel) return;
                const currentVal = sel.value;
                // Preserve 'all' option for filters
                const isFilter = sel.id === 'filter-account' || sel.id === 'analytics-account';
                sel.innerHTML = isFilter ? '<option value="all">All Accounts</option>' : '';

                accounts.forEach(acc => {
                    const o = document.createElement('option');
                    o.value = acc.id;
                    o.textContent = acc.name;
                    sel.appendChild(o);
                });
                if (currentVal && Array.from(sel.options).some(o => o.value === currentVal)) {
                    sel.value = currentVal;
                }
            });
        }

        function getAccountName(accountId) {
            // If no accountId, return default account name
            if (!accountId) {
                return accounts[0]?.name || 'Main Account';
            }
            const acc = accounts.find(a => a.id === accountId);
            // If account not found, return default account name
            return acc ? acc.name : (accounts[0]?.name || 'Main Account');
        }

        // --- Core UI Logic ---
        function formatCurrency(amt) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amt); }


        function addTransaction(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('amount').value);
            const desc = document.getElementById('description').value.trim() || 'Untitled';
            const type = document.getElementById('type').value;
            const cat = document.getElementById('category').value;
            const date = new Date(document.getElementById('transaction-date').value).toISOString();
            const accountId = document.getElementById('transaction-account').value || accounts[0]?.id || 'default';
            const toAccountId = type === 'transfer' ? document.getElementById('to-account').value : null;

            if (type === 'transfer' && accountId === toAccountId) {
                alert("Transfer source and destination must be different.");
                return;
            }

            const baseData = { date, amount: amt, description: desc, type, category: type === 'transfer' ? 'Transfer' : cat, accountId };
            if (type === 'transfer') baseData.toAccountId = toAccountId;

            if (editingTransactionId) {
                const updated = { id: editingTransactionId, ...baseData };
                if (!currentUser) transactions[transactions.findIndex(t => String(t.id) === String(editingTransactionId))] = updated;
                saveData(updated, null);
            } else {
                const newTx = { id: Date.now(), ...baseData };
                if (!currentUser) transactions.unshift(newTx);
                saveData(newTx, null);
            }
            if (!currentUser) renderUI();
            toggleModal('add-modal');
        }

        function editTransaction(id) {
            const tx = transactions.find(t => String(t.id) === String(id));
            if (!tx) return;
            editingTransactionId = id;
            document.getElementById('amount').value = tx.amount;
            document.getElementById('description').value = tx.description;
            document.getElementById('type').value = tx.type;

            updateCategories();

            if (tx.type !== 'transfer') {
                document.getElementById('category').value = tx.category;
            } else {
                if (tx.toAccountId) {
                    const toSel = document.getElementById('to-account');
                    // Check if options are populated (updateCategories does it, but we need to match value)
                    toSel.value = tx.toAccountId;
                }
            }

            document.getElementById('transaction-date').value = tx.date.split('T')[0];
            // Set account
            const accSelect = document.getElementById('transaction-account');
            if (accSelect && tx.accountId) {
                accSelect.value = tx.accountId;
            } else if (accSelect && accounts.length > 0) {
                accSelect.value = accounts[0].id;
            }
            document.getElementById('modal-title').textContent = "Edit Transaction";
            document.getElementById('submit-btn').textContent = "Update Transaction";
            toggleModal('add-modal');
        }

        function openAddModal() {
            editingTransactionId = null;
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-title').textContent = "New Transaction";
            document.getElementById('submit-btn').textContent = "Add Transaction";
            updateCategories();
            updateAccountSelectors();
            // Default to first account
            const accSelect = document.getElementById('transaction-account');
            if (accSelect && accounts.length > 0) {
                accSelect.value = accounts[0].id;
            }
            toggleModal('add-modal');
        }

        let pendingDeleteId = null;

        function deleteTransaction(id, event) {
            if (event) event.stopPropagation();
            pendingDeleteId = id;
            toggleModal('delete-modal');
        }

        function closeDeleteModal() {
            pendingDeleteId = null;
            toggleModal('delete-modal');
        }

        function confirmDelete() {
            if (pendingDeleteId) {
                if (!currentUser) transactions = transactions.filter(t => String(t.id) !== String(pendingDeleteId));
                saveData(null, pendingDeleteId);
                pendingDeleteId = null;
            }
            toggleModal('delete-modal');
        }
        function toggleModal(id) { const m = document.getElementById(id); m.classList.toggle('active'); }
        function toggleProfileMenu() { document.getElementById('profile-menu').classList.toggle('hidden'); }
        function toggleMoreMenu() { document.getElementById('more-menu').classList.toggle('hidden'); }
        window.onclick = (e) => {
            if (!e.target.closest('#user-profile')) document.getElementById('profile-menu').classList.add('hidden');
            if (!e.target.closest('#more-menu') && !e.target.closest('[onclick*="toggleMoreMenu"]')) document.getElementById('more-menu').classList.add('hidden');
        }

        // --- Refresh App ---
        function refreshApp() {
            const btn = document.getElementById('refresh-btn');
            if (btn) btn.classList.add('animate-spin');

            // Reload data from storage
            loadCategories();
            loadAccounts();
            if (currentUser && isFirebaseReady) {
                loadFromCloud();
            } else {
                loadFromLocal();
            }
            updateCategories();
            updateAccountSelectors();

            setTimeout(() => {
                if (btn) btn.classList.remove('animate-spin');
                showToast('Refreshed!');
            }, 500);
        }

        // --- Filter Panel ---
        function toggleFilterPanel() {
            const panel = document.getElementById('filter-panel');
            panel.classList.toggle('hidden');
        }

        function clearFilters() {
            document.getElementById('filter-account').value = 'all';
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            updateFilterBadge();
            renderUI();
        }

        function updateFilterBadge() {
            const account = document.getElementById('filter-account').value;
            const type = document.getElementById('filter-type').value;
            const dateStart = document.getElementById('filter-date-start').value;
            const dateEnd = document.getElementById('filter-date-end').value;

            let count = 0;
            if (account !== 'all') count++;
            if (type !== 'all') count++;
            if (dateStart) count++;
            if (dateEnd) count++;

            const badge = document.getElementById('active-filter-badge');
            const clearBtn = document.getElementById('clear-filter-btn');
            if (count > 0) {
                badge.textContent = count + ' filter' + (count > 1 ? 's' : '');
                badge.classList.remove('hidden');
                if (clearBtn) clearBtn.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                if (clearBtn) clearBtn.classList.add('hidden');
            }

            // Save filters to localStorage
            saveFilters();
        }

        function saveFilters() {
            const filters = {
                account: document.getElementById('filter-account')?.value || 'all',
                type: document.getElementById('filter-type')?.value || 'all',
                dateStart: document.getElementById('filter-date-start')?.value || '',
                dateEnd: document.getElementById('filter-date-end')?.value || ''
            };
            localStorage.setItem('transactionFilters', JSON.stringify(filters));
        }

        function loadFilters() {
            const saved = localStorage.getItem('transactionFilters');
            if (saved) {
                const filters = JSON.parse(saved);
                const accEl = document.getElementById('filter-account');
                const typeEl = document.getElementById('filter-type');
                const startEl = document.getElementById('filter-date-start');
                const endEl = document.getElementById('filter-date-end');

                if (typeEl && filters.type) typeEl.value = filters.type;
                if (startEl && filters.dateStart) startEl.value = filters.dateStart;
                if (endEl && filters.dateEnd) endEl.value = filters.dateEnd;

                // Account filter needs to wait for accounts to load
                setTimeout(() => {
                    if (accEl && filters.account) {
                        // Check if the saved account still exists
                        const optionExists = Array.from(accEl.options).some(o => o.value === filters.account);
                        if (optionExists) accEl.value = filters.account;
                    }
                    updateFilterBadge();
                    renderUI();
                }, 100);
            }
        }

        // --- Pull to Refresh (Mobile) ---
        let pullStartY = 0;
        let isPulling = false;
        let pullDistance = 0;
        const pullThreshold = 60;

        function initPullToRefresh() {
            const main = document.getElementById('main-container');
            const indicator = document.getElementById('pull-indicator');
            const pullIcon = document.getElementById('pull-icon');
            const pullText = document.getElementById('pull-text');

            if (!main || !indicator) return;

            main.addEventListener('touchstart', (e) => {
                if (main.scrollTop <= 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                    pullDistance = 0;
                }
            }, { passive: true });

            main.addEventListener('touchmove', (e) => {
                if (!isPulling || main.scrollTop > 0) {
                    isPulling = false;
                    return;
                }

                pullDistance = e.touches[0].clientY - pullStartY;

                if (pullDistance > 0) {
                    // Prevent overscroll bounce on iOS
                    e.preventDefault();

                    const progress = Math.min(pullDistance / pullThreshold, 1);
                    const translateY = Math.min(pullDistance * 0.5, 60);

                    // Show and position indicator
                    indicator.style.transform = `translateY(${translateY}px)`;
                    indicator.style.opacity = progress;
                    pullIcon.style.transform = `rotate(${progress * 360}deg)`;

                    if (pullDistance >= pullThreshold) {
                        pullText.textContent = 'Release to refresh';
                        indicator.querySelector('div').classList.add('bg-blue-50');
                    } else {
                        pullText.textContent = 'Pull to refresh';
                        indicator.querySelector('div').classList.remove('bg-blue-50');
                    }
                }
            }, { passive: false });

            main.addEventListener('touchend', () => {
                if (!isPulling) return;

                // Reset indicator
                indicator.style.transform = '';
                indicator.style.opacity = '0';
                pullIcon.style.transform = '';

                if (pullDistance >= pullThreshold) {
                    refreshApp();
                }

                isPulling = false;
                pullDistance = 0;
            }, { passive: true });
        }

        // Initialize pull to refresh after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPullToRefresh);
        } else {
            initPullToRefresh();
        }

        // --- Privacy Logic ---
        function togglePrivacy() {
            privacyMode = !privacyMode;
            localStorage.setItem('privacyMode', privacyMode);
            if (privacyMode) {
                document.body.classList.add('privacy-active');
                showToast('🙈 Balances Hidden');
            } else {
                document.body.classList.remove('privacy-active');
                showToast('👀 Balances Visible');
            }
            updatePrivacyIcon();
        }

        function updatePrivacyIcon() {
            const icon = document.getElementById('privacy-icon');
            if (icon) icon.className = privacyMode ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
        }

        // --- Render UI ---
        function renderUI() {
            const list = document.getElementById('transaction-list');
            const filterType = document.getElementById('filter-type').value;
            const filterDateStart = document.getElementById('filter-date-start')?.value;
            const filterDateEnd = document.getElementById('filter-date-end')?.value;
            const filterAccount = document.getElementById('filter-account')?.value || 'all';
            let data = transactions;

            // Account filter - also include transactions without accountId when filtering by default account
            if (filterAccount !== 'all') {
                const defaultAccId = accounts[0]?.id || 'default';
                data = data.filter(t => {
                    const matchesAccount = t.accountId === filterAccount || t.toAccountId === filterAccount;

                    if (filterAccount === defaultAccId) {
                        // Include transactions that match OR have no accountId (legacy/default)
                        return matchesAccount || (!t.accountId && !t.toAccountId);
                    }
                    return matchesAccount;
                });
            }

            // Date range filter
            if (filterDateStart) {
                const startDate = new Date(filterDateStart);
                startDate.setHours(0, 0, 0, 0);
                data = data.filter(t => new Date(t.date) >= startDate);
            }
            if (filterDateEnd) {
                const endDate = new Date(filterDateEnd);
                endDate.setHours(23, 59, 59, 999);
                data = data.filter(t => new Date(t.date) <= endDate);
            }


            let inc = data.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            let exp = data.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

            // Adjust totals for transfer if requested (include in income/expense for volume)
            // But per requirement "Transfers should have two entry 1. From <entity> 2. To <entity>" logic suggests user wants to see it.
            // My previous implementation correctly handles "From" and "To" in the filter views.
            // To make it "count" for total income/expense in 'All Accounts' view:
            if (filterAccount === 'all') {
                // We need to re-calculate inc/exp to include transfers
                const transferSum = data.filter(t => t.type === 'transfer').reduce((s, t) => s + t.amount, 0);
                inc += transferSum;
                exp += transferSum;
            }

            document.getElementById('total-balance').textContent = formatCurrency(inc - exp);
            document.getElementById('total-income').textContent = formatCurrency(inc);
            document.getElementById('total-expense').textContent = formatCurrency(exp);

            if (filterType !== 'all') data = data.filter(t => t.type === filterType);
            list.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('empty-state').classList.replace('hidden', 'flex');
                return;
            }
            document.getElementById('empty-state').classList.replace('flex', 'hidden');

            const groups = {};
            data.forEach(t => {
                const k = new Date(t.date).toLocaleString('en-IN', { month: 'long', year: 'numeric' });
                if (!groups[k]) groups[k] = { items: [], total: 0 };

                if (t.type === 'transfer' && filterAccount === 'all') {
                    // Split into two entries: One Debit (From), One Credit (To)

                    // 1. Debit Entry (From Account)
                    const debitItem = { ...t, _isVirtual: true, _virtualType: 'debit', amount: -Math.abs(t.amount) };
                    groups[k].items.push(debitItem);

                    // 2. Credit Entry (To Account)
                    const creditItem = { ...t, _isVirtual: true, _virtualType: 'credit', amount: Math.abs(t.amount) };
                    groups[k].items.push(creditItem);

                    // Net total change is 0
                } else {
                    groups[k].items.push(t);
                    if (t.type === 'transfer') {
                        if (filterAccount !== 'all') {
                            if (t.accountId === filterAccount) groups[k].total -= t.amount;
                            else if (t.toAccountId === filterAccount) groups[k].total += t.amount;
                        }
                    } else {
                        groups[k].total += (t.type === 'income' ? t.amount : -t.amount);
                    }
                }
            });

            Object.keys(groups).forEach(key => {
                const g = groups[key];
                const gid = key.replace(/ /g, '-');
                list.innerHTML += `
                    <div class="flex justify-between items-center px-2 py-2 cursor-pointer select-none" onclick="toggleGroup('${gid}')">
                        <div class="flex items-center gap-2"><i id="icon-${gid}" class="fa-solid fa-chevron-down text-slate-400 text-xs"></i><h4 class="text-xs font-bold text-slate-500 uppercase">${key}</h4></div>
                        <span class="text-xs font-bold privacy-sensitive ${g.total >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(g.total)}</span>
                    </div>
                    <div id="group-${gid}" class="flex flex-col md:grid md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4 overflow-hidden transition-all" style="max-height: 2000px">
                        ${g.items.map(t => {
                    const isInc = t.type === 'income';
                    const isTrf = t.type === 'transfer';
                    const accName = getAccountName(t.accountId);
                    const toAccName = t.toAccountId ? getAccountName(t.toAccountId) : '';

                    let bgClass = isInc ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-500';
                    let icon = iconMap[t.category] || 'fa-circle';
                    let amountClass = isInc ? 'text-green-600' : 'text-red-400';
                    let sign = isInc ? '+' : '-';
                    let title = t.description;
                    let displayAccName = accName;

                    // Locked Data Handling
                    if (t.isLocked) {
                        return `
                    <div class="transaction-card bg-slate-50 p-4 rounded-2xl shadow-sm border border-slate-200 flex gap-3 relative group opacity-75" onclick="promptToUnlock()">
                        <div class="w-10 h-10 rounded-xl bg-slate-200 text-slate-500 flex items-center justify-center text-lg shadow-sm shrink-0"><i class="fa-solid fa-lock"></i></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 text-base leading-tight mb-0.5 truncate">Encrypted Data</h4>
                            <p class="text-xs text-slate-500">Tap to unlock</p>
                        </div>
                        <div class="flex items-center"><span class="font-bold text-base text-slate-400">Locked</span></div>
                    </div>`;
                    }

                    if (isTrf) {
                        bgClass = 'bg-blue-100 text-blue-600';
                        icon = 'fa-arrow-right-arrow-left';
                        amountClass = 'text-blue-600';

                        // Handle Split Transfer Views
                        if (t._isVirtual) {
                            if (t._virtualType === 'debit') {
                                // "From Account" Entry (The sender side)
                                title = "To " + toAccName;
                                displayAccName = accName; // Show source account in badge
                                sign = '-';
                                amountClass = 'text-slate-600';
                            } else {
                                // "To Account" Entry (The receiver side)
                                title = "From " + accName;
                                displayAccName = toAccName; // Show dest account in badge
                                sign = '+';
                                amountClass = 'text-green-600';
                            }
                        } else {
                            // Single Account View / Legacy
                            if (filterAccount !== 'all') {
                                if (t.accountId === filterAccount) { sign = '-'; amountClass = 'text-slate-600'; title = "To " + toAccName; }
                                else if (t.toAccountId === filterAccount) { sign = '+'; amountClass = 'text-green-600'; displayAccName = toAccName; title = "From " + accName; }
                            } else {
                                sign = '';
                                title = `${t.description} (${accName} ➝ ${toAccName})`;
                            }
                        }
                    }

                    return `
                    <div class="transaction-card bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-3 relative group" onclick="toggleCardActions(this)">
                        <div class="w-10 h-10 rounded-xl ${bgClass} flex items-center justify-center text-lg shadow-sm shrink-0"><i class="fa-solid ${icon}"></i></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 text-base leading-tight mb-0.5 truncate">${title}</h4>
                            <div class="flex items-center gap-2 text-xs text-slate-500 font-medium flex-wrap"><span class="bg-slate-100 px-2 py-0.5 rounded">${t.category}</span><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded"><i class="fa-solid fa-wallet text-[10px] mr-1"></i>${displayAccName}</span><span>${new Date(t.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })}</span></div>
                        </div>
                        <div class="flex items-center"><span class="font-bold text-base privacy-sensitive ${amountClass}">${sign}₹${Math.abs(t.amount).toLocaleString('en-IN')}</span></div>
                            <div class="action-buttons hidden absolute top-0 right-0 h-full w-24 bg-gradient-to-l from-white via-white to-transparent flex items-center justify-end pr-2 gap-1">
                                <button onclick="editTransaction('${t.id}'); event.stopPropagation()" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 active:scale-90 transition"><i class="fa-solid fa-pen text-xs"></i></button>
                                <button onclick="deleteTransaction('${t.id}', event); event.stopPropagation()" class="w-8 h-8 rounded-full bg-red-50 text-red-600 flex items-center justify-center hover:bg-red-100 active:scale-90 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        </div>`;
                }).join('')}
            </div>`;
            });
        }

        function toggleGroup(id) {
            const el = document.getElementById(`group-${id}`);
            const ic = document.getElementById(`icon-${id}`);
            if (el.style.maxHeight === '0px') { el.style.maxHeight = '2000px'; el.style.opacity = '1'; el.style.marginBottom = '1rem'; ic.style.transform = 'rotate(0deg)'; }
            else { el.style.maxHeight = '0px'; el.style.opacity = '0'; el.style.marginBottom = '0'; ic.style.transform = 'rotate(-90deg)'; }
        }

        function toggleCardActions(card) {
            const isSelected = card.classList.contains('selected');

            // Remove selection and hide actions from all cards
            document.querySelectorAll('.transaction-card').forEach(c => {
                c.classList.remove('selected');
                c.querySelector('.action-buttons').classList.add('hidden');
            });

            // If card was not selected, select it and show actions
            if (!isSelected) {
                card.classList.add('selected');
                card.querySelector('.action-buttons').classList.remove('hidden');
            }
        }

        // --- Analytics & Export ---
        let charts = {};
        function toggleAnalytics() { document.getElementById('analytics-modal').classList.toggle('active'); setFilter('thisMonth'); }
        function setFilter(type) {
            const now = new Date();
            let start, end;
            document.querySelectorAll('.filter-btn').forEach(b => b.className = 'filter-btn px-4 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-500 whitespace-nowrap');
            document.getElementById(`btn-${type}`).className = 'filter-btn px-4 py-2 rounded-full text-xs font-bold bg-primary text-white whitespace-nowrap';
            if (type === 'thisMonth') { start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); }
            else if (type === 'lastMonth') { start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); }
            else { start = new Date(0); end = new Date(); }
            document.getElementById('date-start').value = start.toISOString().split('T')[0];
            document.getElementById('date-end').value = end.toISOString().split('T')[0];
            renderAnalytics(start, end);
        }
        function customDateFilter() { renderAnalytics(new Date(document.getElementById('date-start').value), new Date(document.getElementById('date-end').value)); }
        function renderAnalytics(start, end) {
            const filterAcc = document.getElementById('analytics-account')?.value || 'all';
            const data = transactions.filter(t => {
                const d = new Date(t.date);
                const inDate = d >= start && d <= end;
                if (!inDate) return false;

                if (filterAcc === 'all') return true;

                // For transfers, check both sides
                if (t.type === 'transfer') {
                    return t.accountId === filterAcc || t.toAccountId === filterAcc;
                }
                return t.accountId === filterAcc;
            });

            let inc = 0, exp = 0;
            const expData = {};
            const trendData = {};

            data.forEach(t => {
                const amount = t.amount;
                // Trend Data Helper
                const d = new Date(t.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                if (!trendData[d]) trendData[d] = { i: 0, e: 0 };

                if (t.type === 'income') {
                    inc += amount;
                    trendData[d].i += amount;
                } else if (t.type === 'expense') {
                    exp += amount;
                    trendData[d].e += amount;
                    expData[t.category] = (expData[t.category] || 0) + amount;
                } else if (t.type === 'transfer') {
                    // Logic for Transfers
                    if (filterAcc === 'all') {
                        // In 'All Accounts' view, we can treat transfers as "Activity".
                        // Including them in Expense Chart allows visualizing transfer volume.
                        inc += amount;
                        exp += amount;
                        // Use 'Transfer' or t.category (which is usually Transfer)
                        const cat = t.category || 'Transfer';
                        expData[cat] = (expData[cat] || 0) + amount;

                        trendData[d].i += amount;
                        trendData[d].e += amount;
                    } else {
                        // Specific Account View
                        if (t.accountId === filterAcc) {
                            // Outgoing from this account -> Expense-like
                            exp += amount;
                            const cat = t.category || 'Transfer';
                            expData[cat] = (expData[cat] || 0) + amount;
                            trendData[d].e += amount;
                        } else if (t.toAccountId === filterAcc) {
                            // Incoming to this account -> Income-like
                            inc += amount;
                            trendData[d].i += amount;
                        }
                    }
                }
            });

            document.getElementById('analytics-income').textContent = formatCurrency(inc);
            document.getElementById('analytics-expense').textContent = formatCurrency(exp);
            document.getElementById('analytics-balance').textContent = formatCurrency(inc - exp);

            // Charts
            if (charts.expense) charts.expense.destroy();
            charts.expense = new Chart(document.getElementById('expenseChart'), { type: 'doughnut', data: { labels: Object.keys(expData), datasets: [{ data: Object.values(expData), backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899', '#64748b'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } } });

            const sorted = Object.keys(trendData).sort((a, b) => new Date(a) - new Date(b));
            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(document.getElementById('trendChart'), { type: 'bar', data: { labels: sorted, datasets: [{ label: 'Income', data: sorted.map(d => trendData[d].i), backgroundColor: '#10b981', borderRadius: 4 }, { label: 'Expense', data: sorted.map(d => trendData[d].e), backgroundColor: '#ef4444', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { borderDash: [2, 4] } } }, plugins: { legend: { display: false } } } });

            window.currentReportData = { start, end, data };
        }
        function exportAnalyticsReport() {
            const { start, end, data } = window.currentReportData;
            const inc = data.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const exp = data.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('pdf-date').textContent = `${start.toLocaleDateString()} to ${end.toLocaleDateString()}`;
            document.getElementById('pdf-income').textContent = formatCurrency(inc);
            document.getElementById('pdf-expense').textContent = formatCurrency(exp);
            document.getElementById('pdf-balance').textContent = formatCurrency(inc - exp);
            const tbody = document.getElementById('pdf-table-body'); tbody.innerHTML = '';
            data.forEach(t => { tbody.innerHTML += `<tr class="border-b border-gray-100"><td class="py-2 text-gray-500">${new Date(t.date).toLocaleDateString()}</td><td class="py-2 font-medium">${t.description}</td><td class="py-2 text-gray-500">${t.category}</td><td class="py-2 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</td></tr>`; });
            document.getElementById('pdf-container').classList.remove('hidden');
            html2pdf().from(document.getElementById('pdf-container')).save().then(() => document.getElementById('pdf-container').classList.add('hidden'));
        }
    </script>
</body>

</html>